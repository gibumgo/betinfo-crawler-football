# 🛠️ 리팩토링 상세 보고서 (2025-12-26)

본 문서는 Electron UI 통합 및 코드 품질 향상을 위해 진행된 2차 리팩토링 작업의 상세 내용을 기록합니다.

## 1. 개요
기존의 파편화된 저장 로직과 출력 로직을 단일 책임 원칙(SRP) 및 관심사 분리(SoC) 원칙에 따라 재구조화했습니다. 특히 UI와의 안정적인 통신을 위해 모든 출력물 제어를 중앙 집중화했습니다.

## 2. 주요 개선 사항

### A. IPC 통신 프로토콜 중앙 집중화 (`IPCMessenger`)
- **기존 문제**: 서비스, 파서, 인프라 계층 곳곳에서 `print()`를 직접 사용하여 IPC 프로토콜(STATUS, DATA 등)이 훼손되거나 디버그 로그와 섞일 위험이 있었음.
- **해결**: `src/shared/ipc_messenger.py`를 신설하여 모든 출력을 전담하게 함.
- **효과**:
    - 일반 로그(`log`)와 프로토콜 메시지(`status`, `data`)의 완전한 분리.
    - `--debug` 인자에 따른 출력 제어 일원화.
    - 모든 출력 내용을 `stderr`와 `stdout`으로 적절히 배분하여 Electron 파서의 안정성 확보.

### B. Repository Facade 패턴 도입 (`FlashscoreRepository`)
- **기존 문제**: `FlashscoreMetaService`에서 리그, 팀, 관계 정보를 저장하기 위해 3개 이상의 저장 메서드를 개별적으로 호출해야 했음 (계층 간 결합도 상승).
- **해결**: `save_metadata(metadata_dict)`라는 통합 저장 메서드 추가.
- **효과**:
    - 서비스 계층 코드의 단순화 (30% 이상의 코드 라수 감소).
    - 저장 방식이 변경되더라도 서비스 계층을 수정할 필요가 없는 유연성 확보.

### C. 서비스 계층 및 파서 정제 (`FlashscoreMetaService`, `LeagueMetaParser`)
- **기존 문제**: 서비스 계층 내부에 한국어 출력 메시지(`print`)가 직접 포함되어 있었음.
- **해결**: 
    - 서비스 계층의 모든 직접 출력 제거.
    - `LeagueMetaParser`에서 발생한 미세 오류들을 `IPCMessenger.log`를 통해 디버그 모드에서만 출력되도록 처리.

### D. 의존성 최적화 및 컨트롤러 안정화 (2025-12-26)
- **기존 문제**: 외부 라이브러리 `lxml` 의존성으로 인해 배포 환경에 따라 파싱 실패 가능성. CLI 컨트롤러의 예외 처리 로직에 정의되지 않은 상수 참조로 인한 2차 Crash 발생.
- **해결**:
    - 모든 `BeautifulSoup` 호출부의 파서를 내장 `html.parser`로 교체.
    - `CliFlashscoreController`의 URL 처리 로직 고도화 (League ID 추출 및 시즌별 URL 정규화).
    - 예외 처리 블록의 NameError 전수 수정 및 로깅 강화.

## 3. 리팩토링 전후 비교

| 항목 | 리팩토링 전 | 리팩토링 후 |
| :--- | :--- | :--- |
| **출력 관리** | 각 파일에서 `print()` 직접 호출 | `IPCMessenger` 정적 메서드 호출 |
| **저장 로직 (Meta)** | 서비스에서 개별 객체별 저장 호출 | `save_metadata()` Facade 호출 |
| **로그 관리** | stdout에 무조건 로깅 | `--debug` 플래그에 따라 stderr로 로깅 |
| **결합도** | 서비스와 Repository 메서드 간 강한 결합 | Facade를 통한 느슨한 결합 |

## 4. 향후 과제
- 도메인 모델(League, Team)에 팩토리 메서드(`from_element`)를 추가하여 파서 내부의 객체 생성 로직을 도메인으로 더 이동시킬 수 있음.
- 현재의 `FlashscorePage` 객체에 더 많은 Scraping 행위를 캡슐화하여 서비스 계층에서 Selenium 드라이버 직접 참조를 0%로 만드는 작업 필요.

---
**리포트 생성 일자**: 2025-12-26  
**담당**: Antigravity (AI Assistant)
